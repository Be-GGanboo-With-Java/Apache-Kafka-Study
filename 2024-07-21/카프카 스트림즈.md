# 카프카 스트림즈를 왜 써야 하는가?

## 각자의 의견
- 컨슈밍 이후의 후속 조치 필요하기 때문?
- 실시간 데이터의 스트리밍성 데이터 정제 및 처리에 용이
- 카프카 스트림즈를 사용하면, 별도의 프로듀싱, 컨슈밍 작업 없이 데이터를 코드로 쉽고 빠르게 정제 및 처리할 수 있다.
- exactly once 를 보장하기 때문에, 처리 로직에 집중할 수 있다.
- 예시
  - 여러 토픽에서 데이터를 가져오는 Source Processor
  - KStream, KTable, GlobalKTable 등으로 레코드를 가져온다.
  - 가져온 레코드를 Stream Processor 를 통해, 레코드의 정제를 진행하거나, 분기 가능
  - 분기 된 레코드의 경우 Sink Processor 를 통해 다른 목적의 토픽으로 전송 가능
  - 정제 된 레코드의 경우 역시 Sink Processor 를 통해 목적의 맞는 토픽으로 전송 가능하다.
  - 이상 로그인 감지 시스템
  - 광고 정산 시스템
  - 주문 상품, 유튜브 영상 등의 알고리즘 추천에도 사용 가능할듯

## 카프카 스트림즈의 KTable, GlobalKTable
- KTable 의 경우, 키 값으로 매칭
- GlobalKTable 의 경우 키와 값 모두 매칭 가능
- https://velog.io/@hamkua/%EC%95%84%ED%8C%8C%EC%B9%98-%EC%B9%B4%ED%94%84%EC%B9%B4-%EC%A1%B0%EC%9D%B8

## 테크 기업 들의 카프카 스트림즈 사용 사례
https://medium.com/musinsa-tech/%ED%97%88%ED%8A%BC%EC%A7%93%EC%9D%80-%EA%B7%B8%EB%A7%8C-kafka-streams%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EC%8B%A4%EC%8B%9C%EA%B0%84-%EC%9D%B4%EC%83%81-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EA%B0%90%EC%A7%80-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EB%8F%84%EC%9E%85%ED%95%98%EA%B8%B0-d05768b78c86
https://www.bucketplace.com/post/2022-05-20-%EA%B4%91%EA%B3%A0-%EC%A0%95%EC%82%B0-%EC%8B%9C%EC%8A%A4%ED%85%9C%EC%97%90-kafka-streams-%EB%8F%84%EC%9E%85%ED%95%98%EA%B8%B0/

# 카프카 메시지 중복 처리 방어에 대한 이야기

## 부제 : 차드 : 카프카를 이용했을 때, 컨슈밍 마이그레이션 계획

카프카 컨슈머 그룹이 바뀌어야 했던 상황  
- 카프카 컨슈머 로직을 제거한 변경 본으로 배포 진행  
- 마이그레이션 스크립트 실행
- 변경 카프카 컨슈머 그룹을 새로 배포
- 잠시 메시지 컨슈밍이 중단 되었기에, 배포 사이 이벤트에 대한 추가 대응
- ^ 추가 이벤트는 다른 테이블에 쌓아두고 스크립트 커맨드 실행하면 될듯 하다. 굳이 새롭게 처리 로직을 추가한 애플리케이션 배포는 비효율적

카프카 메시지를 중복 컨슈밍에 대해 어떻게 방어할 수 있을 것인가?

### 차드의 의견
- offset id 를 얻어올 수 있다.
- 차드는 rdbms 에 offset 을 pk 로 걸어서 저장하겠다.
  - pk 로 쓴 이유는 auto_increment 사용 못함
  - 이 테이블은 컨슈밍 그룹 바꿀 때 잠시 사용하기에, 그 순간만 사용할 테이블
  - auto_increment 속성이 필요가 없기 때문
  - RDBMS 를 사용하는 이유는, 기존에 쓰는 리소스이기 때문
- Drop Table 해서 테이블 제거
- 차드 회사는 메시지 발행 시, 키를 토픽 이름으로 넣는다;;
- 메시지 키는 이벤트 당 최대한 유니크 한 값으로 전송하는 것으로 하자.

### 그루비의 의견
- Redis 를 써서 메시지 키를 저장한다.
- 일반적으로 메시지 키는 유니크하기 때문에, 유일한 키 값 저장 가능.
- 메모리 기반 DB 이기 때문에, 중복 컨슈밍 방지 용이
- Redis 에 해당 키가 있다면, continue, 없으면, 넣어 놓은 후 로직 수행 후 키 제거
- 나의 의견은, offset 보다는 message key 가 유니크하지 않을까라는 생각
